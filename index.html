<!DOCTYPE html>
<meta charset="utf-8">
<head>
<style>

body {
  font: 12px sans-serif;
  background-color: #eee;
}

.container {
    width: 1080px;
    margin: 40px auto 0 auto;
    padding: 60px;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.bar {
  fill: steelblue;
}

.x.axis path {
  display: none;
}

p#male.selected, p#female.selected {
    border: 1px solid #999;
    font-weight: bold;
    background-color: #ddd;
    color: #999;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

p#male, p#female {
    display: inline;
    text-transform: uppercase;
    border: 1px solid #fff;
    color: #fff;
    padding: 10px 20px;
    border-radius: 10px;
    margin: 10px;
    cursor: pointer;
}

p#male {
    background-color: rgb(138, 137, 166);
}

p#female {
    background-color: rgb(152, 171, 197);
}

</style>
</head>
<body>
<div class="container">
    <h2>Top books by gender (ratio)</h2>
    <p>Some prejudices about gender seem to be true: Females loan more books about diets, while males like to read about stamps.</p><br>
    <p id="female"> Top 25 female book loans </p>
    <p id="male"> Top 25 male book loans </p>
    <div id="top25"></div>
    <h2>Ages of book readers</h2>
    <p>The difference between what people of different ages read is noticable in books such as Den Gode Opgave and Jesus, Pengene og Livet.<br>
    The former (a study book) is mostly read by younger audiences, while the latter (a biography) have a much older audience.</p>
    <p>Also notice the very young readers (less than 5 years) loaning heavy books such as Zornig's biography depicting her awful childhood.<br>
    This could be interpreted as either bad data or people using their child's loaner card to be allowed to keep their book a bit longer.</p>
    Choose book (top 10 female loans) <select name="" id="book">
        <option value="0">Zornig - vrede er mit mellemnavn</option>
        <option value="1">Den gode opgave</option>
        <option value="2">Sværkeslægten</option>
        <option value="3">Turen går til London</option>
        <option value="4">Vi kan sove i flyvemaskinen</option>
        <option value="5">Turen går til Hamburg og Nordtyskland</option>
        <option value="6">3096 dage</option>
        <option value="7">Turen går til Berlin</option>
        <option value="8">Jesus, pengene og livet</option>
        <option value="9">Turen går til Tyrkiet</option>
    </select>
    <div id="top10"></div>
    
    <h2>Book loans during the year</h2>
    <p>Again, we see a clear trend in loans of the study book Den Gode Opgave, which seems to drop drastically during the summer vacation and grow again once the fall semester begins.<br>
    On the other hand, the diet book 5:2 Kuren has its peak at summertime.</p>
    Choose book (top 10 loans in 2014) <select name="" id="year">
        <option value="0">Så skal der leves!</option>
        <option value="1">Forfulgt</option>
        <option value="2">Den gode opgave</option>
        <option value="3">Den hemmelige socialdemokrat</option>
        <option value="4">Ikke et sekund spildt</option>
        <option value="5">Turen går til Hamburg og Nordtyskland</option>
        <option value="6">Jesus, pengene og livet</option>
        <option value="7">5:2 kuren</option>
        <option value="8">Turen går til London</option>
        <option value="9">Zornig - vrede er mit mellemnavn</option>
    </select>
    <div id="book_by_month"></div>
</div>    

<script src="//d3js.org/d3.v3.min.js"></script>
<script>


var margin = {top: 20, right: 20, bottom: 60, left: 60},
    width = 960 - margin.left - margin.right,
    height = 560 - margin.top - margin.bottom;

var color = d3.scale.ordinal()
    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b"]);

function buildBar(dataset) {
    var genderNames = d3.keys(dataset[0]).filter(function(key) { return (key !== "title") && (key !== 'female_count') && (key !== 'male_count') ; });
    
      dataset.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
          return {name: name, value: +d[name]}; });
      });

    var x0 = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);    
        
    x0.domain(dataset.map(function(d) { return d.title; }));
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, d3.max(dataset, function(d) { return d3.max(d.gender, function(d) { return d.value; }); })]);
        
    var xAxis = d3.svg.axis()
        .scale(x0)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#top25").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom + 240)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", -50)
      .attr("x", -150)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Ratio of Loans / No. of loans");

  var title = svg.selectAll(".title")
      .data(dataset)
    .enter().append("g")
      .attr("class", "title")
      .attr("transform", function(d) { return "translate(" + x0(d.title) + ",0)"; });

  title.selectAll("rect")
      .data(function(d) { return d.gender; })
        .enter().append("rect")
      .attr("width", x1.rangeBand())
      .attr("x", function(d) { return x1(d.name); })
      .attr("y", function(d) { return y(d.value); })
      .attr("height", function(d) { return height - y(d.value); })
      .style("fill", function(d) { return color(d.name); });

  var legend = svg.selectAll(".legend")
      .data(genderNames.slice().reverse())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
      .attr("x", width - 18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", color);

  legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });
}

function updateBar(temp_data){

    var genderNames = d3.keys(temp_data[0]).filter(function(key) { return (key !== "title") && (key !== 'female_count') && (key !== 'male_count') ; });
    
    temp_data.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
           return {name: name, value: +d[name]}; });
    });
    
    
    var x0 = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);  

    x0.domain(temp_data.map(function(d) { return d.title; }));
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, d3.max(temp_data, function(d) { return d3.max(d.gender, function(d) { return d.value; }); })]);

    var xAxis = d3.svg.axis()
        .scale(x0)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#top25").select("svg");
    
    svg.selectAll(".x.axis")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });
    
    var title = svg.selectAll(".title")
        .data(temp_data)
    
    title.selectAll("rect")
        .data(function(d) { return d.gender; })
        .transition()
        .attr("width", x1.rangeBand())
        .attr("x", function(d) { return x1(d.name); })
        .attr("y", function(d) { return y(d.value); })
        .attr("height", function(d) { return height - y(d.value); })
        .style("fill", function(d) { return color(d.name); });    
}

function buildAgeBar(dataset) {
    var genderNames = d3.keys(dataset[0]).filter(function(key) { return (key == "0") ; });
    
      dataset.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
          return {name: name, value: +d[name]}; });
      });

    var x0 = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);    
        
    x0.domain(dataset.map(function(d) { return d.age; }));
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, 1110]);
    //y.domain([0, d3.max(dataset, function(d) { return d3.max(d.gender, function(d) { return d.value; }); })]);

    var formatxAxis = d3.format('.0f');
    
    var xAxis = d3.svg.axis()
        .scale(x0)
        //.scale(d3.range(0, 101, 10))
        //.tickValues(d3.range(0, 101, 10))
        //.ticks(5)
        .tickFormat(formatxAxis)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#top10").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("font-size", "8px")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", -50)
      .attr("x", -150)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Number of book loans");

  var title = svg.selectAll(".title")
      .data(dataset)
    .enter().append("g")
      .attr("class", "title")
      .attr("transform", function(d) { return "translate(" + x0(d.age) + ",0)"; });

  title.selectAll("rect")
      .data(function(d) { return d.gender; })
        .enter().append("rect")
      .attr("width", x1.rangeBand())
      .attr("x", function(d) { return x1(d.name); })
      .attr("y", function(d) { return y(d.value); })
      .attr("height", function(d) { return height - y(d.value); })
      .style("fill", function(d) { return color(d.name); });

}

function updateAgeBar(temp_data, col){

    var genderNames = d3.keys(temp_data[0]).filter(function(key) { return (key == col) ; });
    
    temp_data.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
           return {name: name, value: +d[name]}; });
    });
    
    
    var x0 = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);  

    x0.domain(temp_data.map(function(d) { return d.age; }));
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, 1110]);
    
    var formatxAxis = d3.format('.0f');
    
    var xAxis = d3.svg.axis()
        .scale(x0)
        .tickFormat(formatxAxis)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#top10").select("svg");
    
    svg.selectAll(".x.axis")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });
    
    var title = svg.selectAll(".title")
        .data(temp_data)
    
    title.selectAll("rect")
        .data(function(d) { return d.gender; })
        .transition()
        .attr("width", x1.rangeBand())
        .attr("x", function(d) { return x1(d.name); })
        .attr("y", function(d) { return y(d.value); })
        .attr("height", function(d) { return height - y(d.value); })
        .style("fill", function(d) { return color(d.name); });    
}

function buildMonthBar(dataset) {
    var genderNames = d3.keys(dataset[0]).filter(function(key) { return (key == "0") ; });
    
      dataset.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
          return {name: name, value: +d[name]}; });
      });

    var x0 = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);    
        
    x0.domain(dataset.map(function(d) { return d.month; }));
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, 600]);
    //y.domain([0, d3.max(dataset, function(d) { return d3.max(d.gender, function(d) { return d.value; }); })]);
    
    var xAxis = d3.svg.axis()
        .scale(x0)
        //.scale(d3.range(0, 101, 10))
        //.tickValues(d3.range(0, 101, 10))
        //.ticks(5)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#book_by_month").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", -50)
      .attr("x", -150)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Number of book loans");

  var title = svg.selectAll(".title")
      .data(dataset)
    .enter().append("g")
      .attr("class", "title")
      .attr("transform", function(d) { return "translate(" + x0(d.month) + ",0)"; });

  title.selectAll("rect")
      .data(function(d) { return d.gender; })
        .enter().append("rect")
      .attr("width", x1.rangeBand())
      .attr("x", function(d) { return x1(d.name); })
      .attr("y", function(d) { return y(d.value); })
      .attr("height", function(d) { return height - y(d.value); })
      .style("fill", function(d) { return color(d.name); });

}

function updateMonthBar(temp_data, col){

    var genderNames = d3.keys(temp_data[0]).filter(function(key) { return (key == col) ; });
    
    temp_data.forEach(function(d) {
        d.gender = genderNames.map(function(name) { 
           return {name: name, value: +d[name]}; });
    });
    
    
    var x0 = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);
    
    var x1 = d3.scale.ordinal();
    
    var y = d3.scale.linear()
        .range([height, 0]);  

    x0.domain(temp_data.map(function(d) { return d.month; }));
    x1.domain(genderNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, 600]);
    
    
    var xAxis = d3.svg.axis()
        .scale(x0)
        .orient("bottom");
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));
    
    var svg = d3.select("#book_by_month").select("svg");
    
    svg.selectAll(".x.axis")
      .call(xAxis)
      .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("text-overflow", "ellipsis")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });
    
    var title = svg.selectAll(".title")
        .data(temp_data)
    
    title.selectAll("rect")
        .data(function(d) { return d.gender; })
        .transition()
        .attr("width", x1.rangeBand())
        .attr("x", function(d) { return x1(d.name); })
        .attr("y", function(d) { return y(d.value); })
        .attr("height", function(d) { return height - y(d.value); })
        .style("fill", function(d) { return color(d.name); });    
}
      
d3.csv("data/fem_top25.csv", function(error, data) {
  d3.csv("data/mal_top25.csv", function(error,data2){
      d3.csv("data/fem_top10_by_age.csv", function(error,data3){
          d3.csv("data/loans_by_month.csv", function(error,data4){
          if (error) throw error;
            dataset = data;
            dataset2 = data2;
            dataset3 = data3;
            dataset4 = data4;
            dataset_total = data.concat(data2);
        
          
            buildBar(dataset);
            var selector = d3.select("#female");
            selector.classed("selected", true);
            
            buildAgeBar(dataset3);
            
            buildMonthBar(dataset4);
        
            d3.selectAll("p")
                    .on("click", function() {
                    //See which p was clicked
                    var paragraphID = d3.select(this).attr("id");
                    
                    if (paragraphID == "male") {
                      var temp_data = dataset2;
                      updateBar(temp_data);
                      var selector = d3.select("#male");
                      selector.classed("selected", true);
                      var unselector = d3.select("#female");
                      unselector.classed("selected", false);
                    }
                    if (paragraphID == "female") {
                      //Remove a value
                      var temp_data = dataset;
                      updateBar(temp_data);
                      var selector = d3.select("#female");
                      selector.classed("selected", true);
                      var unselector = d3.select("#male");
                      unselector.classed("selected", false);
                    } 
                
                    });
            d3.select("#book").on("change", changebook)
                function changebook() {
                var sel = document.getElementById('book');
                var val = sel.options[sel.selectedIndex].value;
                updateAgeBar(dataset3, val);
            }

            d3.select("#year").on("change", changebook2)
                function changebook2() {
                var sel = document.getElementById('year');
                var val = sel.options[sel.selectedIndex].value;
                updateMonthBar(dataset4, val);
            }
            
            });
        });
    
    });

});
</script>